(()=>{"use strict";const e=require("express"),s=require("mongoose"),t=require("dotenv");t.config();const a=process.env.PORT||8e3,r=s.Schema({name:{type:String,required:!0},email:{type:String,required:!0,unique:!0},password:{type:String,required:!0},user_role:{type:String,required:!0},isActive:{type:Boolean,default:!1},resetPasswordToken:{type:String},resetPasswordExpires:{type:Date}},{timestamps:!1,versionKey:!1}),n=s.model("user",r),o=s.Schema({user_id:{type:String,required:!0},bdm:{type:String,required:!0},branch_name:{type:String,required:!0},company_name:{type:String},contact_person:{type:String,required:!0},email:{type:String,required:!0},contact_no:{type:Number,required:!0},services:{type:[String],required:!0},closed_by:{type:String},total_amount:{type:Number,required:!0},term_1:{type:Number},term_2:{type:Number},term_3:{type:Number},payment_date:{type:Date},pan:{type:String},gst:{type:String},remark:{type:String},date:{type:Date,required:!0},after_disbursement:{type:String},bank:{type:String},state:{type:String,required:!0},status:{type:String},updatedhistory:[{updatedBy:String,updatedAt:{type:Date,default:Date.now},note:String,changes:{type:Map,of:new s.Schema({old:s.Schema.Types.Mixed,new:s.Schema.Types.Mixed},{_id:!1})}}],isDeleted:{type:Boolean,default:!1},deletedAt:{type:Date,default:null},deletedBy:{type:String,default:null}},{versionKey:!1,timestamps:!0}),i=s.model("booking",o),d=require("crypto"),u=require("nodemailer"),c=require("bcrypt"),l=require("jsonwebtoken"),m=async(e,s,t)=>{try{const a=e.headers.authorization;if(!a)return s.status(401).send({message:"Authentication required"});const r=l.verify(a,process.env.JWT_SECRET);e.user=r,t()}catch(e){return s.status(401).send({message:"Invalid or expired token"})}},p=(e,s,t)=>{if("srdev"!==e.user?.user_role)return s.status(403).send({message:"Access denied. Only devs can access this route."});t()};t.config();const g=e.Router();g.post("/adduser",m,p,async(e,s)=>{try{const{name:t,email:a,password:r,user_role:o}=e.body;if(!t||!a||!r)return s.status(400).send({message:"send all required fields: name, email, password"});const i=a.toLowerCase();if(await n.findOne({email:i}))return s.status(409).send({message:"Email is already registered"});const d={name:t,email:i,password:await c.hash(r,5),user_role:o},u=await n.create(d);return s.status(201).send(u)}catch(e){return console.log(e.message),s.status(500).send({message:e.message})}}),g.patch("/edituser/:id",m,p,async(e,s)=>{try{const{id:t}=e.params,a=e.body;if(!a||0===Object.keys(a).length)return s.status(400).send({message:"No fields provided for update"});if(a.email&&(a.email=a.email.toLowerCase(),await n.findOne({email:a.email,_id:{$ne:t}})))return s.status(409).send({message:"Email is already registered"});a.password&&(a.password=await c.hash(a.password,5));const r=await n.findByIdAndUpdate(t,{$set:a},{new:!0,runValidators:!0});return r?s.status(200).send({message:"User updated successfully",user:r}):s.status(404).send({message:"User not found"})}catch(e){return console.error(e.message),s.status(500).send({message:e.message})}}),g.delete("/deleteuser/:id",m,p,async(e,s)=>{try{const{id:t}=e.params;return await n.findById(t)?(await n.findByIdAndDelete(t),s.status(200).send({message:"User deleted successfully"})):s.status(404).send({message:"User not found"})}catch(e){return console.log(e.message),s.status(500).send({message:e.message})}}),g.get("/all",m,p,async(e,s)=>{try{const e=await n.find({}).select("-password");if(0===e.length)return s.status(404).send({message:"No Users found"});e.length,s.status(200).send({Users:e})}catch(e){return console.log(e.message),s.status(500).send({message:e.message})}}),g.post("/auth/login",async(e,s)=>{try{const{email:t,password:a}=e.body;if(!t||!a)return s.status(400).send({message:"Please provide both email and password."});const r=await n.findOneAndUpdate({email:t},{isActive:!0});if(!r)return s.status(404).send({message:"User not found."});if(!await c.compare(a,r.password))return s.status(401).send({message:"Invalid email or password."});const o=(e=>l.sign({userId:e._id,user_role:e.user_role},process.env.JWT_SECRET,{expiresIn:"24h"}))(r),i=r.toObject();delete i.password,s.status(200).json({success:!0,token:o,user:i})}catch(e){return console.log(e.message),s.status(500).send({message:e.message})}}),g.patch("/logout/:id",async(e,s)=>{const{id:t}=e.params;try{const e=await n.findByIdAndUpdate(t,{isActive:!1});if(!e)return s.status(404).send({message:"User not found."});s.send(e)}catch(e){return s.status(500).send({message:e.message})}}),g.get("/bookings/:id",m,async(e,s)=>{const t=e.params.id;try{if(!e.params.id)return s.status(400).send({message:"Not A VALID USER"});const a=await i.find({user_id:t});if(0===a.length)return s.status(404).send({message:"No bookings found for this user"});s.status(200).send(a)}catch(e){return console.log(e.message),s.status(500).send({message:e.message})}}),g.get("/:id?",m,async(e,s)=>{const t=e.params.id,a=e.query.pattern,r=e.query.userRole,n=e.query.userId;parseInt(a);try{let e;if(t){if(e=["dev","admin","senior admin","srdev"].includes(r)?await i.find({_id:t}):await i.find({_id:t,user_id:n}),0===e.length)return s.status(404).send({message:"No bookings found with this id"})}else{if(!a)return s.status(400).send({message:"Either id or pattern query parameter is required"});{const t={$or:[{company_name:{$regex:a,$options:"i"}},{contact_person:{$regex:a,$options:"i"}},{email:{$regex:a,$options:"i"}},{pan:{$regex:a,$options:"i"}},{gst:{$regex:a,$options:"i"}},{services:{$regex:a,$options:"i"}},{bdm:{$regex:a,$options:"i"}},{$expr:{$regexMatch:{input:{$toString:"$contact_no"},regex:a}}}]};if(e=["dev","admin","senior admin","srdev"].includes(r)?await i.find(t):await i.find({...t,user_id:n}),0===e.length)return s.status(404).send({message:"No bookings found matching the pattern"})}}s.status(200).send(e)}catch(e){return console.log(e.message),s.status(500).send({message:e.message})}}),g.get("/:id",async(e,s)=>{const t=e.params.id;try{if(!e.params.id)return s.status(400).send({message:"Not A VALID USER"});if(0===(await n.find({_id:t})).length)return s.status(404).send({message:"No User found with this id",status:!1});s.status(200).send({message:"VALID USER",status:!0})}catch(e){return console.log(e.message),s.status(500).send({message:e.message})}}),g.put("/password-reset",async(e,s)=>{const{password:t,email:a}=e.body;if(!a||!t)return s.status(400).send({message:"Please provide both email and new password"});const r=a.toLowerCase();try{const e=await n.findOne({email:r});if(!e)return s.status(404).send({message:"User not found with this email"});const a=await c.hash(t,5);return e.password=a,await e.save(),s.status(200).send({message:"Password updated successfully"})}catch(e){return console.log(e.message),s.status(500).send({message:e.message})}}),g.post("/request-reset-password",async(e,s)=>{const{email:t}=e.body;try{const e=await n.findOne({email:t});if(!e)return s.status(404).json({message:"User not found"});const a=d.randomBytes(20).toString("hex"),r=Date.now()+36e5;e.resetPasswordToken=a,e.resetPasswordExpires=r,await e.save();const o=`http://localhost:5353/user/reset-password/${a}`,i=u.createTransport({host:"smtp.hostinger.com",port:465,secure:!0,auth:{user:"siteadmin@enego.co.in",pass:"Siteadmin@enego@321"}}),c={to:e.email,from:"siteadmin@enego.co.in",subject:"Password Reset Request",text:`You are receiving this email because you (or someone else) have requested to reset the password for your account.\n\n\n      Please click the following link, or paste it into your browser to complete the process:\n\n\n      ${o}\n\n\n      If you did not request this, please ignore this email and your password will remain unchanged.`};await i.sendMail(c),s.status(200).json({message:"Password reset link sent to your email."})}catch(e){s.status(500).json({message:"Server error."})}}),g.post("/reset-password/:token",async(e,s)=>{const{token:t}=e.params,{newPassword:a}=e.body;try{const e=await n.findOne({resetPasswordToken:t,resetPasswordExpires:{$gt:Date.now()}});if(!e)return s.status(400).json({message:"Invalid or expired token"});const r=await c.genSalt(5),o=await c.hash(a,r);e.password=o,e.resetPasswordToken=void 0,e.resetPasswordExpires=void 0,await e.save(),s.status(200).json({message:"Password reset successfully"})}catch(e){s.status(500).json({message:"Server error"})}});const y=g,f=e.Router();f.post("/addbooking",m,async(e,s)=>{const{user_id:t,bdm:a,branch_name:r,company_name:n,contact_person:o,email:d,contact_no:u,services:c,total_amount:l,term_1:m,term_2:p,term_3:g,payment_date:y,closed_by:f,pan:h,gst:w,remark:b,date:v,status:S,bank:_,after_disbursement:P,state:k}=e.body,I={branch_name:r,contact_person:o,user_id:t,bdm:a,email:d,services:c,total_amount:l,pan:h,state:k,date:v},q=Object.entries(I).filter(([e,s])=>!s||"services"===e&&(!Array.isArray(s)||0===s.length)).map(([e])=>e);if(q.length>0)return s.status(400).send({message:`Missing required fields: ${q.join(", ")}`});try{const e={user_id:t,bdm:a,branch_name:r,company_name:n||"",contact_person:o,email:d,contact_no:u,closed_by:f,services:c,total_amount:l,term_1:m,term_2:p,term_3:g,payment_date:y,pan:h,gst:w||"N/A",remark:b,date:v||new Date,status:S,bank:_,state:k,after_disbursement:P},I=await i.create(e);return s.status(201).send({Message:"Booking Created Successfully",booking_id:I._id,booking:I})}catch(e){return console.log(e),s.status(500).send({message:e.message})}}),f.patch("/editbooking/:id",m,async(e,s)=>{const{id:t}=e.params;let a=e.body;const r=e.headers["user-role"];if(!r)return s.status(400).send({message:"User role is required"});const{updatedBy:n,note:o}=a;delete a.updatedBy,delete a.note;try{const e=await i.findById(t);if(!e)return s.status(404).send("Booking not found");const d=["dev","senior admin","srdev"];if("admin"===r){const{services:e,...s}=a;a=s}const u={};for(let s in a){const t=e[s],r=a[s];Array.isArray(t)?JSON.stringify(t)!==JSON.stringify(r)&&(u[s]={old:t,new:r}):t!==r&&(u[s]={old:t,new:r})}if(0===Object.keys(u).length)return s.status(400).send({message:"No changes detected"});const c={updatedBy:n||"Unknown",updatedAt:new Date,note:o||"",changes:u};if(d.includes(r)||"admin"===r){const e=await i.findByIdAndUpdate(t,{$set:a,$push:{updatedhistory:c}},{new:!0});return s.status(200).send({message:"Booking Updated Successfully",updatedBooking:e})}return s.status(403).send({message:"You do not have permission to edit this booking"})}catch(e){return s.status(500).send({message:e.message})}}),f.patch("/trash/:id",m,async(e,s)=>{const{id:t}=e.params,a=e.headers["user-role"],r=e.headers["user-name"];if(!a||!["srdev","dev"].includes(a))return s.status(403).send({message:"Only dev or srdev can move bookings to trash."});try{const e=await i.findByIdAndUpdate(t,{isDeleted:!0,deletedAt:new Date,deletedBy:r||"Unknown"},{new:!0});if(!e)return s.status(404).send({message:"Booking not found"});s.status(200).send({message:"Booking moved to trash",trashedBooking:e})}catch(e){s.status(500).send({message:e.message})}}),f.get("/trash",m,async(e,s)=>{const t=e.headers["user-role"];if(!t||"srdev"!==t)return s.status(403).send({message:"Only srdev can view trash."});try{const e=await i.find({isDeleted:!0}).sort({deletedAt:-1});s.status(200).send(e)}catch(e){s.status(500).send({message:e.message})}}),f.patch("/restore/:id",m,async(e,s)=>{const{id:t}=e.params,a=e.headers["user-role"];if(!a||"srdev"!==a)return s.status(403).send({message:"Only srdev can restore trashed bookings."});try{const e=await i.findByIdAndUpdate(t,{isDeleted:!1,deletedAt:null},{new:!0});if(!e)return s.status(404).send({message:"Booking not found"});s.status(200).send({message:"Booking restored successfully",restoredBooking:e})}catch(e){s.status(500).send({message:e.message})}}),f.delete("/deletebooking/:id",m,async(e,s)=>{const{id:t}=e.params;if("srdev"!==e.headers["user-role"])return s.status(403).send({message:"Only srdev can permanently delete bookings."});const a=await i.findById(t);if(!a)return s.status(404).send({message:"Booking not found"});if(!a.isDeleted)return s.status(400).send({message:"You must move this booking to trash before deleting."});try{return await i.findByIdAndDelete(t),s.status(200).send({message:"Booking permanently deleted."})}catch(e){return s.status(500).send({message:e.message})}}),f.get("/getbooking/:id",m,async(e,s)=>{const{id:t}=e.params;try{const e=await i.findById(t);return e?s.status(200).send({booking:e}):s.status(404).send({message:"Booking not found"})}catch(e){return s.status(500).send({message:e.message})}}),f.get("/all",m,async(e,s)=>{try{const e=await i.find({isDeleted:!1}).sort({createdAt:-1});return e.length?s.status(200).send({message:"All Bookings Fetched Successfully",Allbookings:e}):s.status(200).send({message:"No Bookings Found",Allbookings:[]})}catch(e){return console.error("Error in /all:",e.message),s.status(500).send({message:e.message})}}),f.get("/bookings/filter",m,async(e,s)=>{const{startDate:t,endDate:a,status:r,service:n,userId:o,userRole:d,bdmName:u,paymentmode:c,paymentStartDate:l,paymentEndDate:m,page:p=1,limit:g=100}=e.query,y=parseInt(p,10),f=parseInt(g,10);try{const e={};if(t&&a&&!l&&!m){const r=new Date(t),n=new Date(a);if(isNaN(r)||isNaN(n))return s.status(400).send({message:"Invalid booking date format"});n.setHours(23,59,59,999),e.date={$gte:r,$lte:n}}if(l&&m){const t=new Date(l),a=new Date(m);if(isNaN(t)||isNaN(a))return s.status(400).send({message:"Invalid payment date format"});a.setHours(23,59,59,999),e.payment_date={$gte:t,$lte:a}}if(r){if(!["Pending","In Progress","Completed"].includes(r))return s.status(400).send({message:"Invalid status value"});e.status=new RegExp(`^${r.trim()}$`,"i")}if(n&&(e.services={$in:[n]}),c){if(!["Kotak Mahindra Bank","HDFC Bank","Razorpay","HDFC Gateway","CashFree Gateway","Phonepe Gateway","Enego Projects","Cash"].includes(c))return s.status(400).send({message:"Invalid payment mode"});e.bank=c}if(u&&(e.bdm={$regex:new RegExp(u,"i")}),!d||!["dev","admin","senior admin","srdev"].includes(d)){if(!o)return s.status(403).send({message:"Access forbidden. No valid role or user ID provided."});e.user_id=o}e.isDeleted=!1;const p=await i.countDocuments(e),g=await i.find(e).sort({createdAt:-1}).skip((y-1)*f).limit(f);if(!g.length)return s.status(200).send([]);s.status(200).send({bookings:g,totalCount:p,totalPages:Math.ceil(p/f),currentPage:y})}catch(e){console.error("Error in /bookings/filter:",e.message),s.status(500).send({message:e.message})}}),f.get("/getbookings/user/:userId",m,async(e,s)=>{const{userId:t}=e.params;try{const e=await i.find({user_id:t,isDeleted:!1}).sort({createdAt:-1});return e.length?s.status(200).send({message:"User bookings fetched successfully",bookings:e}):s.status(200).send({message:"No bookings found for this user",bookings:[]})}catch(e){return console.error("Error in /getbookings/user/:userId:",e.message),s.status(500).send({message:e.message})}});const h=f,w=s.Schema({label:{type:String,required:!0},value:{type:String,required:!0,unique:!0},status:{type:Boolean,required:!0,default:!0}},{timestamps:!1,versionKey:!1}),b=s.model("service",w),v=e.Router();v.post("/api/services",async(e,s)=>{const{label:t,value:a,status:r}=e.body;if(!t||!a||!r)return s.status(400).send("Invalid input data");const n={label:t,value:a,status:r};try{const e=await b.create(n);s.status(201).send({message:"Service added successfully",Service:e})}catch(e){s.status(500).send({message:"Error adding service",error:e.message})}}),v.patch("/api/services/:id",m,p,async(e,s)=>{const{id:t}=e.params,a=e.body;if(!a||0===Object.keys(a).length)return s.status(400).send({message:"No fields provided for update"});try{const e=await b.findByIdAndUpdate(t,{$set:a},{new:!0,runValidators:!0});if(!e)return s.status(404).send({message:"Service not found"});s.status(200).send({message:"Service updated successfully",service:e})}catch(e){s.status(500).send({message:"Error updating service",error:e.message})}}),v.get("/api/services",m,async(e,s)=>{try{const e=await b.find();if(!e||0===e.length)return s.status(404).send({message:"No services found"});s.status(200).send(e)}catch(e){console.error("Error fetching services:",e),s.status(500).send({message:"Error fetching services",error:e.message})}}),v.delete("/api/services/:id",m,p,async(e,s)=>{const{id:t}=e.params;try{const e=await b.findByIdAndDelete(t);if(!e)return s.status(404).send({message:"Service not found"});s.status(200).send({message:"Service deleted successfully",service:e})}catch(e){s.status(500).send({message:"Error deleting service",error:e.message})}});const S=v;t.config();const _=process.env.MAIL_USER,P=process.env.MAIL_PASS,k=e.Router();k.post("/api/welcome",async(e,s)=>{const{email:t,name:a,amount:r}=e.body;try{const e=u.createTransport({host:"smtp.hostinger.com",port:465,secure:!0,auth:{user:`${_}`,pass:`${P}`}}),r={to:`${t}`,from:"no-reply@finseraa.org",subject:`Warm Welcome to ${a}  from Finsera Ventures Private Limited\n`,html:`\n        <p>Dear Sir/Madam,</p>\n\n        <p>\n          We are pleased to extend a warm welcome to <b>${a}</b> as a valued client of \n          <b>Finsera Ventures Private Limited</b>. We sincerely appreciate the trust youâ€™ve placed in us and are \n          excited about the opportunity to collaborate and contribute to your success.\n        </p>\n\n        <p>\n          At <b>Finsera Ventures Private Limited</b>, we are dedicated to offering high-quality, tailored services \n          designed to meet the unique needs of <b>${a}</b>. Our experienced team is committed to providing \n          expert support and guidance at every stage of our partnership to ensure a smooth and successful experience.\n        </p>\n\n        <p>\n          To facilitate a seamless process, one of our dedicated representatives will be in touch shortly \n          to coordinate with you and gather any necessary information. Please donâ€™t hesitate to reach out \n          with any questions, concerns, or special requests. Your satisfaction is our highest priority, and \n          we are here to support you every step of the way.\n        </p>\n\n        <p>\n          Thank you once again for choosing <b>Finsera Ventures Private Limited</b>. We look forward to a successful \n          and fruitful collaboration, and to helping <b>${a}</b> achieve its business objectives.\n        </p>\n\n        <p>\n          For any queries kindly mail us at <a href="mailto:support@finseraa.org">support@finseraa.org</a>\n        </p>\n\n        <p style="color: #555; font-size: 14px; margin-top: 20px;">\n          <i>This is a system-generated email. Please do not reply to this email.</i>\n        </p>\n\n        <p>Warm regards,</p>\n        <p><b>Finsera Ventures Private Limited</b></p>\n        <p><a href="https://Finseraa.com">Finseraa.com</a></p>\n      `};await e.sendMail(r),s.status(200).json({message:"Welcome Mail Sent Successfully."})}catch(e){s.status(500).json({message:"Server error.",error:e.message})}});const I=k,q=require("cloudinary"),A=require("multer-storage-cloudinary"),N=require("multer");q.v2.config({cloud_name:"dmhuir3hz",api_key:"986751963532472",api_secret:"oj8bzsnD9uIvI32cS6a3oUYI_M0"});const E=N({storage:new A.CloudinaryStorage({cloudinary:q.v2,params:async(e,s)=>{const t=Date.now(),a=e.user?.user_id||"anonymous",r=s.originalname.split(".").pop();return{folder:"employee_profiles",public_id:`${a}_${s.fieldname}_${t}.${r}`,allowed_formats:["jpg","jpeg","png"]}}}),limits:{fileSize:5242880}}),j=s.Schema({userId:{type:String,required:!0,unique:!0},employeeFullName:{type:String,required:!0},employeeId:{type:String,unique:!0},designation:{type:String,required:!0},department:{type:String,required:!0,enum:["Sales","Digital","Admin","Legal","Finance"]},branch:{type:String,required:!0,enum:["Main Branch","407 AMD"]},gender:{type:String,required:!0,enum:["Male","Female","Other"]},maritalStatus:{type:String,required:!0,enum:["Single","Married","Divorced","Widowed"]},dateOfBirth:{type:Date,required:!0},personalContactNumber:{type:String,required:!0},personalEmailAddress:{type:String,required:!0,lowercase:!0,trim:!0},workEmail:{type:String,required:!0,lowercase:!0,trim:!0},workPhoneNumber:{type:String,required:!0},permanentAddress:{type:String,required:!0},currentAddress:{type:String,required:!0},emergencyContactName:{type:String,required:!0},emergencyContactNumber:{type:String,required:!0},emergencyContactRelationship:{type:String,required:!0,enum:["Father","Mother","Spouse","Brother","Sister","Friend","Other"]},dateOfJoining:{type:Date,required:!0},reportingManager:{type:String,required:!0},offeredSalary:{type:String,required:!0},dateOfLastPromotion:{type:Date},educationQualification:{type:String,required:!0},previousEmployer:{type:String},totalWorkExperience:{type:String,required:!0},accountNumber:{type:String,required:!0},bankName:{type:String,required:!0},ifscCode:{type:String,required:!0},panNumber:{type:String,required:!0,uppercase:!0,trim:!0},aadharNumber:{type:String,required:!0},employeePhoto:{type:String,required:!0},aadhaarCardPhoto:{type:String,required:!0},isActive:{type:Boolean,default:!0},profileCompletionStatus:{type:String,enum:["incomplete","pending_review","approved","rejected"],default:"pending_review"},createdBy:{type:String},updatedBy:{type:String},approvedBy:{type:String},approvedAt:{type:Date},updateHistory:[{updatedBy:{type:String,required:!0},updatedAt:{type:Date,default:Date.now},changes:{type:Map,of:{oldValue:s.Schema.Types.Mixed,newValue:s.Schema.Types.Mixed}},reason:{type:String}}]},{timestamps:!0,versionKey:!1});j.pre("save",async function(e){if(this.isNew&&!this.employeeId)try{const e={Sales:"SL",Digital:"DG",Admin:"AD",Legal:"LG",Finance:"FN"}[this.department]||"EMP",s=(new Date).getFullYear().toString().slice(-2),t=await this.constructor.findOne({employeeId:new RegExp(`^${e}${s}`)}).sort({employeeId:-1});let a=1;t&&t.employeeId&&(a=parseInt(t.employeeId.slice(-4))+1),this.employeeId=`${e}${s}${a.toString().padStart(4,"0")}`,this.createdBy=this.userId}catch(s){return e(s)}e()}),j.index({userId:1}),j.index({employeeId:1}),j.index({department:1}),j.index({branch:1}),j.index({personalEmailAddress:1}),j.index({workEmail:1});const $=s.model("EmployeeProfile",j),D=e.Router(),B=(e,s,t)=>{if("HR"!==e.user.user_role)return s.status(403).json({message:"Access denied. Only HR personnel can perform this action."});t()};D.use(m),D.get("/all",B,async(e,s)=>{try{const{page:t=1,limit:a=50,department:r,branch:n,status:o,search:i}=e.query,d={isActive:!0};r&&(d.department=r),n&&(d.branch=n),o&&(d.profileCompletionStatus=o),i&&(d.$or=[{employeeFullName:{$regex:i,$options:"i"}},{employeeId:{$regex:i,$options:"i"}},{personalEmailAddress:{$regex:i,$options:"i"}},{workEmail:{$regex:i,$options:"i"}}]);const u=(parseInt(t)-1)*parseInt(a),[c,l]=await Promise.all([$.find(d).select("-updateHistory -__v").sort({createdAt:-1}).skip(u).limit(parseInt(a)),$.countDocuments(d)]);s.json({employees:c,pagination:{currentPage:parseInt(t),totalPages:Math.ceil(l/parseInt(a)),totalEmployees:l,hasNext:u+c.length<l,hasPrev:parseInt(t)>1}})}catch(e){console.error("GET /all error:",e),s.status(500).json({error:"Server error",details:e.message})}}),D.get("/profile/:id",(e,s,t)=>{const a=e.params.id;if(e.user.userId!==a&&"HR"!==e.user.role)return s.status(403).json({message:"Access denied. You can only access your own profile or need HR privileges."});t()},async(e,s)=>{try{const t=await $.findOne({userId:e.params.id,isActive:!0}).select("-updateHistory -__v");if(!t)return s.status(404).json({error:"Profile not found"});s.json({profile:t})}catch(e){console.error("GET /profile/:id error:",e),s.status(500).json({error:"Server error",details:e.message})}}),D.post("/profile",E.fields([{name:"employeePhoto",maxCount:1},{name:"aadhaarCardPhoto",maxCount:1}]),(e,s,t)=>{const a=["employeeFullName","designation","department","branch","gender","maritalStatus","dateOfBirth","personalContactNumber","personalEmailAddress","workEmail","workPhoneNumber","permanentAddress","currentAddress","emergencyContactName","emergencyContactNumber","emergencyContactRelationship","dateOfJoining","reportingManager","offeredSalary","educationQualification","totalWorkExperience","accountNumber","bankName","ifscCode","panNumber","aadharNumber"].filter(s=>!e.body[s]);if(a.length>0)return s.status(400).json({error:"Missing required fields",missingFields:a});const r=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!r.test(e.body.personalEmailAddress)||!r.test(e.body.workEmail))return s.status(400).json({error:"Invalid email format"});const n=/^\d{10}$/;return n.test(e.body.personalContactNumber.replace(/\D/g,""))&&n.test(e.body.workPhoneNumber.replace(/\D/g,""))?/^[A-Z]{5}[0-9]{4}[A-Z]{1}$/.test(e.body.panNumber.toUpperCase())?/^\d{12}$/.test(e.body.aadharNumber.replace(/\D/g,""))?void t():s.status(400).json({error:"Invalid Aadhar number format"}):s.status(400).json({error:"Invalid PAN number format"}):s.status(400).json({error:"Invalid phone number format"})},async(e,s)=>{try{if(await $.findOne({userId:e.user.userId}))return s.status(400).json({error:"Profile already exists for this user"});if(!e.files?.employeePhoto||!e.files?.aadhaarCardPhoto)return s.status(400).json({error:"Both employee photo and Aadhaar card photo are required"});if(await $.findOne({$or:[{personalEmailAddress:e.body.personalEmailAddress.toLowerCase()},{workEmail:e.body.workEmail.toLowerCase()}]}))return s.status(400).json({error:"Email address already exists in the system"});const t={userId:e.user.userId,...e.body,personalEmailAddress:e.body.personalEmailAddress.toLowerCase(),workEmail:e.body.workEmail.toLowerCase(),panNumber:e.body.panNumber.toUpperCase(),employeePhoto:e.files.employeePhoto[0].path,aadhaarCardPhoto:e.files.aadhaarCardPhoto[0].path,createdBy:e.user.userId},a=new $(t);await a.save();const r=a.toObject();delete r.updateHistory,s.status(201).json({message:"Employee profile created successfully",profile:r})}catch(e){if(console.error("POST /profile error:",e),11e3===e.code){const t=Object.keys(e.keyPattern)[0];return s.status(400).json({error:`${t} already exists in the system`})}s.status(500).json({error:"Server error",details:e.message})}}),D.put("/update/:id",B,async(e,s)=>{try{const t=await $.findOne({userId:e.params.id,isActive:!0});if(!t)return s.status(404).json({error:"Profile not found"});const a=new Map,r={};if(["employeeFullName","designation","department","branch","gender","maritalStatus","dateOfBirth","personalContactNumber","personalEmailAddress","workEmail","workPhoneNumber","permanentAddress","currentAddress","emergencyContactName","emergencyContactNumber","emergencyContactRelationship","dateOfJoining","reportingManager","dateOfLastPromotion","educationQualification","previousEmployer","totalWorkExperience","accountNumber","bankName","ifscCode","panNumber","aadharNumber"].forEach(s=>{void 0!==e.body[s]&&e.body[s]!==t[s]&&(a.set(s,{oldValue:t[s],newValue:e.body[s]}),r[s]=e.body[s])}),e.files?.employeePhoto&&(a.set("employeePhoto",{oldValue:t.employeePhoto,newValue:e.files.employeePhoto[0].path}),r.employeePhoto=e.files.employeePhoto[0].path),e.files?.aadhaarCardPhoto&&(a.set("aadhaarCardPhoto",{oldValue:t.aadhaarCardPhoto,newValue:e.files.aadhaarCardPhoto[0].path}),r.aadhaarCardPhoto=e.files.aadhaarCardPhoto[0].path),0===Object.keys(r).length)return s.status(400).json({message:"No changes detected"});r.updatedBy=e.user.userId,r.$push={updateHistory:{updatedBy:e.user.userId,changes:a,reason:e.body.updateReason||"Profile update"}};const n=await $.findOneAndUpdate({userId:e.params.id},r,{new:!0,runValidators:!0}).select("-updateHistory -__v");s.json({message:"Profile updated successfully",profile:n,changesCount:a.size})}catch(e){if(console.error("PUT /update/:id error:",e),11e3===e.code){const t=Object.keys(e.keyPattern)[0];return s.status(400).json({error:`${t} already exists in the system`})}s.status(500).json({error:"Server error",details:e.message})}}),D.delete("/delete/:id",B,async(e,s)=>{try{const t=await $.findOneAndUpdate({userId:e.params.id,isActive:!0},{isActive:!1,updatedBy:e.user.userId,$push:{updateHistory:{updatedBy:e.user.userId,changes:new Map([["isActive",{oldValue:!0,newValue:!1}]]),reason:e.body.reason||"Profile deactivated"}}},{new:!0});if(!t)return s.status(404).json({error:"Profile not found"});s.json({message:"Employee profile deactivated successfully",employeeId:t.employeeId})}catch(e){console.error("DELETE /delete/:id error:",e),s.status(500).json({error:"Server error",details:e.message})}}),D.post("/approve/:id",B,async(e,s)=>{try{const t=await $.findOneAndUpdate({userId:e.params.id,isActive:!0},{profileCompletionStatus:"approved",approvedBy:e.user.userId,approvedAt:new Date,updatedBy:e.user.userId,$push:{updateHistory:{updatedBy:e.user.userId,changes:new Map([["profileCompletionStatus",{oldValue:"pending_review",newValue:"approved"}]]),reason:"Profile approved by HR"}}},{new:!0}).select("-updateHistory -__v");if(!t)return s.status(404).json({error:"Profile not found"});s.json({message:"Employee profile approved successfully",profile:t})}catch(e){console.error("POST /approve/:id error:",e),s.status(500).json({error:"Server error",details:e.message})}}),D.get("/stats",B,async(e,s)=>{try{const[e,t,a,r,n]=await Promise.all([$.countDocuments({isActive:!0}),$.aggregate([{$match:{isActive:!0}},{$group:{_id:"$department",count:{$sum:1}}},{$sort:{count:-1}}]),$.aggregate([{$match:{isActive:!0}},{$group:{_id:"$branch",count:{$sum:1}}},{$sort:{count:-1}}]),$.aggregate([{$match:{isActive:!0}},{$group:{_id:"$profileCompletionStatus",count:{$sum:1}}}]),$.find({isActive:!0}).sort({dateOfJoining:-1}).limit(5).select("employeeFullName employeeId department dateOfJoining")]);s.json({totalEmployees:e,departmentStats:t,branchStats:a,statusStats:r,recentJoinees:n})}catch(e){console.error("GET /stats error:",e),s.status(500).json({error:"Server error",details:e.message})}}),D.get("/export",B,async(e,s)=>{try{const{format:t="json",department:a,branch:r}=e.query,n={isActive:!0};a&&(n.department=a),r&&(n.branch=r);const o=await $.find(n).select("-updateHistory -__v -employeePhoto -aadhaarCardPhoto").sort({employeeId:1});if("csv"===t){const e=["Employee ID","Full Name","Designation","Department","Branch","Personal Email","Work Email","Personal Phone","Work Phone","Date of Joining","Reporting Manager"].join(","),t=o.map(e=>[e.employeeId,e.employeeFullName,e.designation,e.department,e.branch,e.personalEmailAddress,e.workEmail,e.personalContactNumber,e.workPhoneNumber,e.dateOfJoining?.toISOString().split("T")[0]||"",e.reportingManager].join(",")).join("\n");s.setHeader("Content-Type","text/csv"),s.setHeader("Content-Disposition","attachment; filename=employees.csv"),s.send(e+"\n"+t)}else s.json({employees:o,count:o.length})}catch(e){console.error("GET /export error:",e),s.status(500).json({error:"Server error",details:e.message})}});const C=D,x=s.Schema({invoiceNumber:{type:String,required:!0},date:{type:String,required:!0},clientCompanyName:{type:String,required:!0},clientName:{type:String,required:!0},clientEmail:{type:String,required:!0},clientAddress:{type:String},clientGstNumber:{type:Number},items:{type:Array,required:!0},subtotal:{type:Number,required:!0},gstRate:{type:Number},gstAmount:{type:Number,required:!0},total:{type:Number,required:!0},includeGst:{type:Boolean}},{timestamps:!1,versionKey:!1}),R=s.model("invoice",x),O=e.Router();O.post("/",async(e,s)=>{try{const t=new R(e.body);await t.save(),s.status(201).json(t)}catch(e){s.status(400).json({error:e.message})}}),O.get("/",async(e,s)=>{try{const e=await R.find();s.json(e)}catch(e){s.status(500).json({error:e.message})}}),O.get("/:id",async(e,s)=>{try{const t=await R.findById(e.params.id);if(!t)return s.status(404).json({error:"Invoice not found"});s.json(t)}catch(e){s.status(500).json({error:e.message})}}),O.put("/:id",async(e,s)=>{try{const t=await R.findByIdAndUpdate(e.params.id,e.body,{new:!0});if(!t)return s.status(404).json({error:"Invoice not found"});s.json(t)}catch(e){s.status(400).json({error:e.message})}}),O.delete("/:id",async(e,s)=>{try{if(!await R.findByIdAndDelete(e.params.id))return s.status(404).json({error:"Invoice not found"});s.json({message:"Invoice deleted"})}catch(e){s.status(500).json({error:e.message})}});const U=O,T=s.Schema({name:{type:String,required:!0},companyName:{type:String},phoneNumber:{type:String,required:!0},email:{type:String,required:!0},location:{type:String},service:{type:String},message:{type:String},assignedTo:{type:String,required:!0,default:"unassigned"}},{timestamps:!0,versionKey:!1}),M=s.model("email",T),L=e.Router();L.post("/add",async(e,s)=>{const{name:t,companyName:a,phoneNumber:r,email:n,location:o,service:i,message:d}=e.body;if(!t||!r||!n)return s.status(400).send({message:"name, phoneNumber and email are required"});try{if(await M.findOne({email:n,phoneNumber:r}))return s.status(409).send({message:"Entry with same email and phone already exists"});const e=await M.create({name:t,companyName:a,phoneNumber:r,email:n,location:o,service:i,message:d});return s.status(201).send({message:"Email entry created",id:e._id,created:e})}catch(e){return console.error(e),s.status(500).send({message:e.message})}}),L.get("/all",async(e,s)=>{try{const e=await M.find().sort({createdAt:-1});return s.status(200).send(e)}catch(e){return console.error(e),s.status(500).send({message:e.message})}}),L.get("/:id",async(e,s)=>{const{id:t}=e.params;try{const e=await M.findById(t);return e?s.status(200).send(e):s.status(404).send({message:"Not found"})}catch(e){return console.error(e),s.status(500).send({message:e.message})}}),L.patch("/:id",async(e,s)=>{const{id:t}=e.params,a=e.body;try{const e=await M.findByIdAndUpdate(t,{$set:a},{new:!0});return e?s.status(200).send({message:"Updated successfully",updated:e}):s.status(404).send({message:"Not found"})}catch(e){return console.error(e),s.status(500).send({message:e.message})}}),L.delete("/:id",async(e,s)=>{const{id:t}=e.params;if("srdev"!==e.headers["user-role"])return s.status(403).send({message:"Only srdev can permanently delete entries."});try{return await M.findById(t)?(await M.findByIdAndDelete(t),s.status(200).send({message:"Deleted successfully"})):s.status(404).send({message:"Not found"})}catch(e){return console.error(e),s.status(500).send({message:e.message})}});const F=L,V=e.Router();V.get("/all",async(e,s)=>{try{const e=await M.find({assignedTo:"unassigned"}).sort({createdAt:-1});return s.status(200).send(e)}catch(e){return console.error(e),s.status(500).send({message:e.message})}}),V.patch("/edit/:id",m,async(e,s)=>{const{id:t}=e.params,a=e.body;try{const e=await M.findById(t);if(console.log(e),!e||e.isDeleted)return s.status(404).send({message:"Lead not found"});const r=await M.findByIdAndUpdate(t,{$set:a},{new:!0});return s.status(200).send({message:"Lead updated",updated:r})}catch(e){return console.error(e),s.status(500).send({message:e.message})}}),V.patch("/trash/:id",m,async(e,s)=>{const{id:t}=e.params,a=e.headers["user-name"]||"Unknown";try{const e=await M.findById(t);return!e||e.isDeleted?s.status(404).send({message:"Lead not found"}):(e.isDeleted=!0,e.deletedAt=new Date,e.deletedBy=a,await e.save(),s.status(200).send({message:"Lead moved to trash",lead:e}))}catch(e){return console.error(e),s.status(500).send({message:e.message})}}),V.delete("/delete/:id",m,async(e,s)=>{const{id:t}=e.params;if("srdev"!==e.headers["user-role"])return s.status(403).send({message:"Only srdev can permanently delete leads."});try{return await M.findById(t)?(await M.findByIdAndDelete(t),s.status(200).send({message:"Lead permanently deleted"})):s.status(404).send({message:"Lead not found"})}catch(e){return console.error(e),s.status(500).send({message:e.message})}});const H=V,G=e.Router();G.post("/login",async(e,s)=>{try{const{email:t,password:a}=e.body;if(!t||!a)return s.status(400).send({message:"Please provide both email and password."});const r=await n.findOneAndUpdate({email:t},{isActive:!0});if(!r)return s.status(404).send({message:"User not found."});if(!await c.compare(a,r.password))return s.status(401).send({message:"Invalid email or password."});const o=W(r);s.status(200).send({token:o,user:r})}catch(e){return console.log(e.message),s.status(500).send({message:e.message})}}),G.patch("/logout/:id",async(e,s)=>{const{id:t}=e.params;try{const e=await n.findByIdAndUpdate(t,{isActive:!1});if(!e)return s.status(404).send({message:"User not found."});s.send(e)}catch(e){return s.status(500).send({message:e.message})}});const W=e=>l.sign({userId:e._id,user_role:e.user_role},process.env.JWT_SECRET,{expiresIn:"24h"}),J=G,Q=require("razorpay"),Y=process.env.APPSCRIPT_URL,z=process.env.APPSCRIPT_SECRET;async function K(e){if(!Y)throw new Error("APPSCRIPT_URL not configured");const s={...e,__secret:z},t=await fetch(Y,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),a=await t.json().catch(()=>null);if(!a||!a.success)throw console.error("Failed to append to Google Sheet",a),new Error(a?.message||"Failed to append to Google Sheet");return a}const Z=new s.Schema({customer:{type:String,required:!0,trim:!0},contact:{type:String,required:!0,trim:!0},amount:{type:Number,required:!0,min:1},bdm:{type:String,required:!0,default:""},description:{type:String,trim:!0,default:""},link:{type:String,required:!0,unique:!0,trim:!0},status:{type:String,enum:["PENDING","PAID","EXPIRED","FAILED"],default:"PENDING"},createdOn:{type:Date,default:Date.now}},{timestamps:!0}),X=s.model("PaymentLink",Z),ee=new s.Schema({name:{type:String,required:!0},bdm:{type:String},amount:{type:Number,required:!0},description:{type:String},qr_id:{type:String,required:!0,unique:!0},qr_image:{type:String},usage:{type:String,default:"single_use"},purpose:{type:String,default:"UPI QR Payment"},fixed_amount:{type:Boolean,default:!0},close_by:{type:Number},status:{type:String,default:"Pending",enum:["Pending","Paid","Expired","Cancelled"]},createdOn:{type:Date,default:Date.now}},{timestamps:!0}),se=s.model("PaymentQR",ee);t.config();const te=e.Router(),ae=new Q({key_id:process.env.RAZORPAY_KEY_ID,key_secret:process.env.RAZORPAY_KEY_SECRET});te.post("/create-upi-link",m,async(e,s)=>{try{const{amount:t,name:a,email:r,phone:n,description:o,notifyEmail:i=!0,notifySms:d=!0,bdm:u}=e.body;if(!t||!r||!n)return s.status(400).json({message:"Amount, email & phone are required."});const c=await ae.paymentLink.create({amount:Math.round(100*t),currency:"INR",accept_partial:!1,description:o||"UPI Payment",customer:{name:a||"Customer",email:r,contact:n},notify:{sms:d,email:i},reminder_enable:!0,notes:{purpose:"UPI Payment Link"},callback_url:"https://your-frontend-url.com/payment-status",callback_method:"get"});try{await K({type:"LINK",description:o,email:r,phone:n,bdm:u,paymentLink:c.short_url,amount:t,status:"Pending",name:a})}catch(e){console.error("Sheet logging failed:",e)}return await X.create({customer:a,contact:n,amount:t,bdm:u,description:o,link:c.short_url,status:"Pending",createdOn:new Date}),s.status(200).json({success:!0,message:"Payment link created",payment_link_id:c.id,short_url:c.short_url})}catch(e){console.error("âŒ Razorpay Error:",e),s.status(500).json({message:e.error?.description||e.message||"Payment link creation failed."})}}),te.post("/create-qr",m,async(e,s)=>{try{const{amount:t,bdm:a,name:r,description:n,customer_id:o,purpose:i,usage:d,fixed_amount:u,close_by_hours:c}=e.body;if(!t||!r)return s.status(400).json({success:!1,message:"Amount and name are required"});const l=Math.floor(Date.now()/1e3)+(c?3600*c:86400),m={type:"upi_qr",name:r,usage:d||"single_use",fixed_amount:u??!0,payment_amount:Math.round(100*t),description:n||"UPI QR Payment",close_by:l,notes:{purpose:i||"UPI QR Payment"}};o&&(m.customer_id=o);const p=await ae.qrCode.create(m);let g=null;try{const e=await fetch(p.image_url),s=await e.arrayBuffer();g=Buffer.from(s).toString("base64")}catch(e){console.error("Failed to fetch/convert QR image:",e)}(async()=>{try{await K({type:"QR",name:r,bdm:a,amount:t,description:n,qr_id:p.id,qr_image:p.image_url,usage:d,purpose:i,fixed_amount:u,close_by:l,status:"Pending"})}catch(e){console.error("Sheet logging failed:",e)}})();let y=null;try{y=await se.create({name:r,bdm:a,amount:t,description:n,qr_id:p.id,qr_image:p.image_url,usage:d||"single_use",purpose:i||"UPI QR Payment",fixed_amount:u??!0,close_by:l,status:"Pending",createdOn:new Date})}catch(e){console.error("Failed to save QR to DB:",e)}return s.status(201).json({success:!0,message:"QR Code created",qr_id:p.id,qr_data:p,qr_base64:g?`data:image/png;base64,${g}`:null,savedRecord:y})}catch(e){return console.error("QR create error:",e),s.status(500).json({success:!1,message:e.message||"QR creation failed"})}}),te.get("/api/payment-links",m,async(e,s)=>{try{const e=await X.find().sort({createdOn:-1});s.json({success:!0,count:e.length,data:e})}catch(e){s.status(500).json({success:!1,error:e.message})}}),te.patch("/api/payment-links/:id/status",m,async(e,s)=>{const{id:t}=e.params,{status:a}=e.body;if(!a)return s.status(400).json({success:!1,message:"Status is required."});try{const e=await X.findByIdAndUpdate(t,{$set:{status:a}},{new:!0,runValidators:!0});return e?s.status(200).json({success:!0,message:"Payment link status updated successfully.",data:e}):s.status(404).json({success:!1,message:"Payment link not found."})}catch(e){return console.error("Status update error:",e),s.status(500).json({success:!1,message:"Failed to update payment link status.",error:e.message})}}),te.get("/api/payment-links/:id",m,async(e,s)=>{const{id:t}=e.params;try{const e=await X.findById(t);if(!e)return s.status(404).json({success:!1,message:"Not found"});s.json({success:!0,data:e})}catch(e){s.status(400).json({success:!1,error:e.message})}});const re=te;require("node-cron").schedule("*/60 * * * *",async()=>{console.log("ðŸ§¹ Cron Job: Checking for duplicate leads...");try{const e=await M.find({}),s=new Map,t=[];for(const a of e){const e=`${a.email||""}-${a.phoneNumber||""}`.trim();s.has(e)?t.push(a._id):s.set(e,!0)}if(t.length>0){const e=await M.deleteMany({_id:{$in:t}});console.log(`ðŸ—‘ï¸ Deleted ${e.deletedCount} duplicate leads.`)}else console.log("âœ… No duplicate leads found.")}catch(e){console.error("âŒ Error deleting duplicate leads:",e)}});const ne=require("cors");t.config();const oe=e();oe.use(e.json()),oe.use(ne()),oe.use(ne({origin:"*",methods:["GET","POST","PUT","DELETE","PATCH"],allowedHeaders:["Content-Type","Authorization","user-role"],credentials:!0})),oe.use("/user",y),oe.use("/booking",h),oe.use("/services",S),oe.use("/mail",I),oe.use("/employee",C),oe.use("/invoice",U),oe.use("/email",F),oe.use("/leads",H),oe.use("/admin",J),oe.use("/payments",re),oe.get("/",(e,s)=>{s.send("<h1>server is running successfully</h1>")}),(async()=>{try{const e=await s.connect(process.env.Mongo_URL);console.log(`MongoDB Connected: ${e.connection.host}`)}catch(e){console.log({msg:"cannot connect to db",error:e.message}),process.exit(1)}})().then(()=>{console.log("connected"),oe.listen(a,"0.0.0.0",()=>{console.log(`Server is running at http://0.0.0.0:${a}`)})}).catch(e=>{console.log(e)})})();